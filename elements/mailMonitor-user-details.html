<dom-module id="mailMonitor-user-details">
  <template>
    <style>
      :host {
        display: block;
        padding: 20px;
        color: white;
        box-sizing: border-box;
      }

      paper-radio-group {
        float:left;
        border: dotted white 1px;
      }

      div {
        padding: 2px;
        width: 100%;
        display: inline-block;
        border: solid red 1px;
      }

      div.align {
        /*float: left;*/
        width: 100%;
        display: block 5px;
      }

      /*div.center{
        border:solid blue 1px;
        width: 100%;
        display: inline-block;
      }

      div.center > div { box-sizing: border-box;
        border: solid red 2px;
        margin-left: 50px;
        margin-right: auto;
        /*position: absolute;*/
        /*width: 150px;
        display: inline-block;
      }*/
    </style>
    <style is="custom-style">
      :root {
        --paper-input-container-color: white;
        --paper-input-container-focus-color: white;
        --paper-input-container-input-color: white;

        --paper-radio-button-unchecked-background-color: gray;
        --paper-radio-button-unchecked-color: white;
        --paper-radio-button-label-color: white;
        }

        paper-button.custom {
          color: white;
          clear:both;
          float:left;
          border: solid red 1px;
          margin: 0px;
          margin-top: 10px;
        }

        span.validationError {
          float:left;
          color: red;
        }

        paper-dropdown-menu {
          width: 50%;
        }

        paper-input {
          width: 50%;
        }
    </style>
    <iron-ajax auto
          url="{{url}}"
          handle-as="json"
          last-response="{{handleResponse}}"></iron-ajax>
  <div>
    <form is="iron-form" id="form" method="post" action="/edit">
          <paper-dropdown-menu>
              <paper-menu class="dropdown-content" attr-for-selected="value" selected="{{selection}}">
                      <template is="dom-repeat" items="{{handleResponse}}">
                        <paper-item value={{item.loginName}}>
                          <!-- <a href="{{item.preferredName}}">{{item.preferredName}}</a> -->
                          [[item.preferredName]]
                        </paper-item>
                      </template>
              </paper-menu>
          </paper-dropdown-menu>
          <paper-input label="Email" id="email" value="[[email]]" disabled></paper-input>
    </form>
  </div>
    <!-- <paper-input label="Name" value="{{name}}"></paper-input>
    <span class="validationError">[[validationError]]</span> -->
    <div class="align">
      <paper-radio-group selected="{{type}}">
        <paper-radio-button name="mail"><iron-icon icon="myicons:email"></iron-icon>Letter</paper-radio-button>
        <paper-radio-button name="magazine"><iron-icon icon="myicons:magazine"></iron-icon>Magazine</paper-radio-button>
        <paper-radio-button name="parcel"><iron-icon icon="myicons:parcel"></iron-icon>Parcel</paper-radio-button>
      </paper-radio-group>

      <template is="dom-if" if="{{_isParcel(type)}}" restamp="true">
        <paper-radio-group selected="{{size}}">
          <paper-radio-button name="small"><iron-icon icon="myicons:phone-small"></iron-icon>Small</paper-radio-button>
          <paper-radio-button name="medium"><iron-icon icon="myicons:tablet-medium"></iron-icon>Medium</paper-radio-button>
          <paper-radio-button name="large"><iron-icon icon="myicons:computer-big"></iron-icon>Large</paper-radio-button>
        </paper-radio-group>
      </template>
      <!-- There is some grief in the code below which I'll come back later -->
      <template is="dom-if" if="[[_hasEmail(email)]]">
        <paper-button raised on-tap="send" class="custom">Notify Owner</paper-button>
      </template>
      <template is="dom-if" if="[[_hasNoEmail(email)]]">
        <paper-button raised on-tap="send" class="custom" disabled>Notify Owner</paper-button>
      </template>
      <!-- <paper-button raised on-tap="_insertRecordAndSend" class="custom"><iron-icon icon="myicons:send-mail"></iron-icon>Send An Email</paper-button> -->
    </div>

    <iron-ajax id="send"
          method="POST" url="https://www.googleapis.com/upload/gmail/v1/users/[[user.id]]/messages/send"
          content-type="message/rfc822"
          headers="[[_computeHeader(accessToken)]]"
          body="[[_generateBody(email)]]"
          on-response="_sendEmailResponse"></iron-ajax>

    <google-signin id="login" label-signin="Sign In"
          client-id="795758326945-b9uk1r5iuj2rv3u2jdgcr5v1ksvl2ngh.apps.googleusercontent.com"
          on-google-signed-out="_handleSignout"
          scopes="[[scopes]]"></google-signin>

    <google-signin-aware
          scopes="[[scopes]]"
          on-google-signin-aware-success="_handleSignin"
          on-google-signin-offline-success="_handleOffline"
          on-google-signin-aware-error="_signInError"></google-signin-aware>

    <!-- paper-input label="To" value="[[selection]]@thoughtworks.com"></paper-input> -->
    <!-- <paper-input label="From" value="{{from}}"></paper-input>
    <paper-input label="Subject" value="{{subject}}"></paper-input>
    <paper-input label="Body" value="{{body}}"></paper-input> -->
    <div>
      <template is="dom-bind">
        <iron-ajax url="../currentInventory.json" last-response="{{data}}" auto></iron-ajax>
        <!-- <iron-localstorage id="storage" name="package-list"
            value="{{data}}"
            on-iron-localstorage-load-empty="initializeDataSet">
        </iron-localstorage> -->

          <iron-data-table items="[[data]]">
            <data-table-column name="Receipient">
              <template>[[item.receipient]]</template>
            </data-table-column>
            <data-table-column name="Date of Delivery">
              <template>[[item.dateOfDelivery]]</template>
            </data-table-column>
            <data-table-column name="Type">
              <template>[[item.item.type]]</template>
            </data-table-column>
            <data-table-column name="Size">
              <template>[[item.item.size]]</template>
            </data-table-column>
            <data-table-column name="Status">
              <template>[[item.status]]</template>
            </data-table-column>
          </iron-data-table>
      </template>
    </div>

</template>
  <script>
    (function(Polymer) {
      const clientId = '795758326945-b9uk1r5iuj2rv3u2jdgcr5v1ksvl2ngh.apps.googleusercontent.com';

      Polymer({
        is: 'mailMonitor-user-details',
        properties: {
          name: {type:String, notify:true, value: ''},
          selection: {type:String, notify:true},
          email: {type: String, notify: true, computed: '_generateEmail(selection)'},
          size: {type: String, notify: true, value: 'medium'},
          type: {type: String, notify: true, value: 'mail'},
          user: {type: Object, notify: true },
          accessToken: { type:String, notify:true },
          scopes: { type: String, notify: true, value: 'https://www.googleapis.com/auth/gmail.send' },
          // to: { type: String, notify: true, value: '' },
          // from: { type: String, notify: true, value: 'THOUGHTWORKS MELBOURNE OFFICE' },
          // subject: { type: String, notify: true, value: 'PLEASE COME AND PICK UP YOUR DELIVERY' },
          // body: { type: String, notify: true, value: 'PLEASE COME AND PICK UP YOUR DELIVERY' },
          office: {value: 'melbourne', notify: true},
          url: {computed: '_computeUrl(office)'},
          // newRecord: {
          //   type: Object,
          //   notify: true,
          //   value:   {
          //       "receipient": "",
          //       "dateOfDelivery": "",
          //       "item": {
          //         "type": "",
          //         "size": ""
          //       },
          //       "status": "Notified"
          //     }
          //   }
        },
        observers: [
          '_debug(size)',
          '_debug(user)',
          // '_nameChanged(name)',
        ],
        _hasEmail: function(email) {
          return (email !== undefined && email !== '');
        },
        _hasNoEmail: function(email) {
          return (email === undefined || email === '');
        },
        _generateEmail: function(selected) {
          return selected + '@thoughtworks.com';
        },
        // _generateMyEmail: function(selected) {
        //   this.email = selected + '@thoughtworks.com';
        // },
        _isParcel: function(type) {
          return (type === 'parcel');
        },
        // _nameChanged: function(name) {
        //   if (name !== undefined) {
        //     this.email = name2email(name);
        //   }
        // },
        // _sendEmail: function() {
        //   this.$.emailer.send();
        // },
        _debug: function(object) {
          console.log(object);
        },
        _computeUrl: function(office){
          // return ['https://jigsaw.thoughtworks.net/api/people?staffing_office=', office].join('/');
          return ['./aus_',office,'_consultants.json'].join('');
        },
        send: function() {
          this.$.send.generateRequest();
        },
        _computeHeader: function(accessToken) {
          return {'Authorization': 'Bearer ' + accessToken}
        },
        _sendEmailResponse: function(a) {
          console.log('EMAIL SENT RESPONSE: ', a);
        },
        _generateBody: function(email) {
          var body = "to: " + email + "\n";
          // var body = "to: cathym@thoughtworks.com\n";
          body += "from: mengcx@gmail.com\n";
          body += "subject: ===SUBJECT===\n\n";
          body += "===BODY===\n";
          console.log('------ EMAIL BODY: ', body);
          return body;
        },
        _handleSignin: function(response) {
          var currentUser = gapi.auth2.getAuthInstance()['currentUser'].get();
          var profile = currentUser.getBasicProfile();
          var username = profile.getName();
          var userid = profile.getId();
          var coverImage = this.user && this.user.cover ? this.user.cover : null;

          const user = {
            id: profile.getId(),
            name: profile.getName(),
            profile: profile.getImageUrl(),
            email: profile.getEmail(),
            cover: coverImage
          }
          console.log('USER NAME: ' + username);
          console.log('USER ID: ' + userid);
          console.log('USER EMAIL:' + user.email)
          this.set('user', user);

          const self = this;
          gapi.auth2.authorize({
            client_id: clientId,
            scope: self.scopes,
            immediate: false
          }, function(authorizationResult) {
            if (authorizationResult && !authorizationResult.error) {
              self.accessToken = authorizationResult.access_token;
              console.log('-------------- ACCESS TOKEN: ', self.accessToken);
              //self.$.send.generateRequest();
            }
          });
        },
        _handleSignout: function(response) {
          console.log('Signed out: ', response);
          this.set('user', undefined);
        },
        _handleOffline: function(response) {
          console.log('Offline code received: ' + response.detail.code);
        },
        _signInError: function(a) {
          console.log('SIGN IN ERROR: ', a);
        },
        debug: function(object) {
          console.log('DEBUG CMM-EMAILER: '. object);
        },
        ready: function() {
          console.log('Element cmm-emailer has been created.');
        }
      });

      // function name2email(name) {
      //   if (name.trim().length == 0) { return '';
      //   } else {
      //     var parts = name.replace(' +',' ').split(' ');
      //     var email = parts[0];
      //     if (parts.length > 1 && parts[1].length > 0) {
      //       email += '.' + parts[parts.length - 1].trim();
      //     } else if (parts[0].trim().length > 0){
      //       email = email + '@thoughtworks.com';
      //     }
      //   } return email;
      // };
})(window.Polymer);
</script>
</dom-module>
